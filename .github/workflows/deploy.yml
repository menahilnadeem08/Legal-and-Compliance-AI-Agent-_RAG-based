name: CI/CD Deployment to EC2

on:
  push:
    branches:
      - backend  # Trigger only on backend branch

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout repo locally (optional, for workflow purposes)
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2️⃣ Set up Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20

      # 3️⃣ Install backend dependencies
      - name: Install backend dependencies
        run: cd backend && npm install

      # 4️⃣ Build backend (if needed)
      - name: Build backend
        run: cd backend && npm run build 2>/dev/null || true

      # 5️⃣ Install frontend dependencies
      - name: Install frontend dependencies
        run: cd frontend && npm install

      # 6️⃣ Build frontend
      - name: Build frontend
        run: cd frontend && npm run build

      # 7️⃣ Deploy to EC2
      - name: Deploy to EC2
        uses: appleboy/ssh-action@v0.1.9
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          script: |
            APP_DIR="/home/${{ secrets.EC2_USER }}/app"

            # Install TypeScript globally
            sudo npm install -g typescript

            # Create app directory if it doesn't exist
            mkdir -p $APP_DIR
            cd $APP_DIR

            # Clone or pull master branch
            if [ -d ".git" ]; then
              git fetch origin master
              git checkout master
              git pull origin master
            else
              git clone -b master https://github.com/menahilnadeem08/Legal-and-Compliance-AI-Agent-_RAG-based.git .
            fi

            # Backend .env
            mkdir -p backend
            cat > backend/.env << 'ENVFILE'
            PORT=3001
            DATABASE_URL=${{ secrets.DATABASE_URL }}
            OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
            Cohere_API_Key=${{ secrets.COHERE_API_KEY }}
            ENVFILE

            # Deploy backend
            cd $APP_DIR/backend
            npm install --production
            npm run build || true
            pm2 delete backend 2>/dev/null || true
            pm2 start npm --name "backend" -- start

            # Frontend .env.local
            cd $APP_DIR
            mkdir -p frontend
            cat > frontend/.env.local << 'ENVFILE'
            NEXT_PUBLIC_API_URL=${{ secrets.NEXT_PUBLIC_API_URL }}
            ENVFILE

            # Deploy frontend on port 3000
            cd $APP_DIR/frontend
            npm install --production
            npm run build
            pm2 delete frontend 2>/dev/null || true
            pm2 start npm --name "frontend" -- start -- PORT=3000

            # Save PM2 process list and setup startup
            pm2 save
            pm2 startup || true

      # 8️⃣ Notify on success
      - name: Deployment complete
        run: echo "✅ Deployment to EC2 successful!"
